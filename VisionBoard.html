<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision Board Creator - Dark Mode</title>
    <style>
        /* Base Variables */
        :root {
            --background: #0f172a;
            --surface: #1e293b;
            --primary: #6366f1;
            --primary-hover: #818cf8;
            --text: #e2e8f0;
            --text-secondary: #94a3b8;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --border: #334155;
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        /* Container & Layout */
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        /* Controls Section */
        .controls {
            background: var(--surface);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .controls-grid {
            display: flex;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .control-section {
            background: var(--background);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .control-section-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group {
            display: flex;
            gap: 12px;
            align-items: center;
			margin-top: 10px;
        }

		#control-display {
			flex: 2;
		}
		
        /* Main Actions */
        .main-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        /* Buttons */
        .button-primary {
            flex: 1;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .button-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .button-secondary {
            padding: 8px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .button-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .button-secondary.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Size Inputs */
        .size-inputs {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .size-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .size-input {
            width: 80px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            text-align: center;
        }

        .divider {
            width: 1px;
            height: 24px;
            background: var(--border);
            margin: 0 8px;
        }

        /* Vision Board Layout */
        .vision-board-wrapper {
            position: relative;
            width: 100%;
            //height: calc(100vh - 300px);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: var(--background);
            border-radius: 16px;
            margin-top: 20px;
			padding: 20px;
        }

        .vision-board {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            overflow: auto;
        }

        .vision-board.horizontal {
            width: 1200px;
            height: 800px;
        }

        .vision-board.vertical {
            width: 800px;
            height: 1200px;
        }

		/* עדכון התאמה למסך */
		.vision-board.fit-screen {
			transform-origin: center;
			margin: auto;
		}

        /* Grid Layout */
		.board-grid {
			column-count: 4; /* ברירת מחדל */
			column-gap: 24px;
			padding: 24px;
			height: 100%;
		}

		/* Column variations */
		.board-grid.columns-2,
		.board-grid[data-columns="2"] {
			column-count: 2;
		}

		.board-grid.columns-3,
		.board-grid[data-columns="3"] {
			column-count: 3;
		}

		.board-grid.columns-4,
		.board-grid[data-columns="4"] {
			column-count: 4;
		}

		/* Image container styles */
		.image-container {
			break-inside: avoid;
			margin-bottom: 24px;
			position: relative;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
			border: 2px solid var(--border);
			transition: transform 0.3s ease;
		}

		.image-container img {
			width: 100%;
			height: auto;
			display: block;
			border: 3px solid #000000; /* מסגרת ברירת מחדל בצבע שחור */
			box-sizing: border-box; /* לוודא שהמסגרת לא משפיעה על גודל התמונה */
			border-radius: 5px; /* ניתן להוסיף גם פינות מעוגלות למסגרת */
		}

        .image-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            z-index: 1;
        }

        .image-container.wide {
            grid-column: span 2;
        }

        .image-container.tall {
            grid-row: span 2;
        }

        .image-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: filter 0.3s ease;
        }

        .image-container:hover img {
            filter: brightness(0.9);
        }

		.image-container::after {
			content: '';
			position: absolute;
			bottom: 0;
			left: 0; /* Change from 'right' to 'left' to position on the bottom-left */
			width: 30px; /* Keep the size of the handle */
			height: 30px; /* Keep the size of the handle */
			border-left: 3px solid var(--primary); /* Change to border-left for the left side */
			border-bottom: 3px solid var(--primary); /* Keep bottom border */
			opacity: 0; /* Initially hidden */
			transition: opacity 0.3s ease; /* Smooth transition */
			cursor: sw-resize; /* Change cursor to bottom-left resize */
			z-index: 10; /* Ensure it stays on top */
		}
				
		/* Make the handle visible on hover */
		.image-container:hover::after {
			opacity: 1;
		}
		
		/* Remove all previous resize handle visibility */
		.resize-handle {
			display: none; /* Hide all other handles */
		}

		/* Make the bottom-left (sw) resize handle visible */
		.resize-handle.sw {
			display: block;
			position: absolute;
			width: 15px;
			height: 15px;
			background-color: var(--primary);
			border-radius: 50%;
			bottom: 0; /* Positioned at the bottom */
			left: 0;   /* Positioned at the left */
			cursor: sw-resize; /* Correct cursor for bottom-left resizing */
			opacity: 0; /* Initially hidden */
			transition: opacity 0.3s ease;
		}

		/* Ensure the bottom-left handle becomes visible on hover */
		.image-container:hover .resize-handle.sw {
			opacity: 1;
		}

		/* Hide other resize handles to avoid any confusion */
		.resize-handle.nw,
		.resize-handle.ne,
		.resize-handle.se,
		.resize-handle.top,
		.resize-handle.bottom,
		.resize-handle.left,
		.resize-handle.right {
			display: none !important;
		}
		
        /* Delete Button */
        .delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
            font-size: 18px;
        }

        .image-container:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background-color: var(--danger);
            transform: scale(1.1);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px;
            color: var(--text-secondary);
            border: 2px dashed var(--border);
            border-radius: 12px;
            margin: 24px;
        }

        /* Zoom Controls */
        .zoom-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .zoom-level {
            min-width: 60px;
            text-align: center;
        }

        /* Column Controls */
        .column-controls {
            display: flex;
            gap: 8px;
        }

        /* Scrollbar Styling */
        .board-grid::-webkit-scrollbar {
            width: 8px;
        }

        .board-grid::-webkit-scrollbar-track {
            background: var(--surface);
        }

        .board-grid::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .board-grid::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
	
		/* סגנון נוסף לכפתור החזרה לעמודות */
		#resetToColumnsBtn {
			display: flex;
			align-items: center;
			gap: 8px;
			padding: 8px 16px;
			cursor: pointer;
		}

		#resetToColumnsBtn svg {
			width: 16px;
			height: 16px;
		}

	
		/* הדגשה כשהלוח במצב חופשי */
		.board-grid.resizing ~ .controls #resetToColumnsBtn {
			border-color: var(--primary);
			color: var(--primary);
		}

        /* Responsive Design */
        /* Mobile-first adjustments */
		/* Base Media Queries for Orientation */
		@media screen and (orientation: portrait) {
			.container {
				padding: 10px;
			}

			.main-actions {
				flex-direction: column;
				gap: 10px;
			}

			.controls-grid {
				grid-template-columns: 1fr;
				gap: 16px;
			}

			.vision-board {
				width: 90vw;  /* 90% מרוחב המסך */
				height: auto;
				margin: 0 auto;
			}

			.vision-board.horizontal {
				aspect-ratio: 3/2;
			}

			.vision-board.vertical {
				aspect-ratio: 2/3;
			}

			.board-grid {
				padding: 12px;
				column-count: 2;  /* במצב פורטרט נראה 2 עמודות */
			}

			/* התאמת הכפתורים למצב פורטרט */
			.button-primary {
				width: 100%;
				justify-content: center;
			}

			.control-group {
				flex-wrap: wrap;
				justify-content: center;
			}
		}

		@media screen and (orientation: landscape) {
			.container {
				padding: 20px;
			}

			.main-actions {
				flex-direction: row;
				gap: 16px;
			}

			.controls-grid {
				grid-template-columns: repeat(2, 1fr);
				gap: 24px;
			}

			.vision-board.horizontal {
				width: 80vw;  /* 80% מרוחב המסך */
				aspect-ratio: 3/2;
			}

			.vision-board.vertical {
				height: 80vh;  /* 80% מגובה המסך */
				aspect-ratio: 2/3;
			}

			.board-grid {
				padding: 24px;
				column-count: 4;  /* במצב לנדסקייפ נראה 3 עמודות */
			}
		}

		/* התאמות נוספות למכשירים קטנים במיוחד */
		@media screen and (orientation: portrait) and (max-width: 480px) {
			.board-grid {
				column-count: 1;  /* במסך צר מאוד - עמודה אחת */
			}

			.control-group {
				flex-direction: column;
				align-items: stretch;
			}

			.vision-board {
				width: 95vw;  /* במסך צר יותר - ננצל יותר מקום */
			}
		}

    </style>
</head>

<body>
    <div class="container">
        <div class="controls">
            <div class="main-actions">
                <!-- העלאת תמונות -->
                <input type="file" id="fileInput" accept="image/*" multiple style="display: none">
                <button class="button-primary" onclick="document.getElementById('fileInput').click()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    העלאת תמונות
                </button>

                <!-- Add explicit shuffle button -->
                <button class="button-primary" onclick="shuffleImages()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    ערבוב תמונות
                </button>

                <!-- שמירת תמונה -->
                <button class="button-primary" onclick="downloadBoard()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    שמור כתמונה
                </button>
            </div>

            <div class="controls-grid">
                <!-- הגדרות משטח -->
                <div class="control-section">
                    <div class="control-section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" />
                        </svg>
                        הגדרות משטח
                    </div>
                    <div class="control-group">
                        <div class="size-inputs">
                            <div class="size-input-group">
                                <span>רוחב:</span>
                                <input type="number" id="widthInput" class="size-input" value="1200" min="400" max="2000" step="100" onchange="updateSize()">
                            </div>
                            <div class="size-input-group">
                                <span>גובה:</span>
                                <input type="number" id="heightInput" class="size-input" value="800" min="400" max="2000" step="100" onchange="updateSize()">
                            </div>
                        </div>
                        <div class="divider"></div>
                        <button id="horizontalBtn" class="button-secondary active" onclick="setOrientation('horizontal')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="6" width="18" height="12" rx="2" />
                            </svg>
                            מאוזן
                        </button>
                        <button id="verticalBtn" class="button-secondary" onclick="setOrientation('vertical')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="3" width="12" height="18" rx="2" />
                            </svg>
                            מאונך
                        </button>
                    </div>
                </div>

                <!-- הגדרות תצוגה -->
                <div id="control-display" class="control-section">
                    <div class="control-section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />
                        </svg>
                        תצוגה
                    </div>
                    <div class="control-group">
                        <button id="fitScreenBtn" class="button-secondary" onclick="toggleFitScreen()">
                            התאם למסך
                        </button>
						<div class="divider"></div>
						<!-- כפתור חזרה לעמודות -->
						<button id="resetToColumnsBtn" class="button-secondary active" onclick="resetToColumns()">
							<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M4 6h16M4 12h16M4 18h16"/>
							</svg>
							מצב עמודות
						</button>
                        <div class="divider"></div>
                        <button class="button-secondary" onclick="adjustZoom(-0.1)">-</button>
                        <span id="zoomLevel">100%</span>
                        <button class="button-secondary" onclick="adjustZoom(0.1)">+</button>
                        <div class="divider"></div>
                        <div class="column-controls">
							<button id="col2" class="button-secondary" onclick="setColumns(2)">2</button>
							<button id="col3" class="button-secondary" onclick="setColumns(3)">3</button>
							<button id="col4" class="button-secondary active" onclick="setColumns(4)">4</button>
						</div>
						<label for="backgroundColorPicker">צבע רקע:</label>
						<input type="color" id="backgroundColorPicker" value="#4043B0" onchange="updateBackgroundColor()">
						<label for="borderColorPicker">צבע מסגרת:</label>
						<input type="color" id="borderColorPicker" value="#FFFFFF" onchange="updateBorderColor()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Vision Board Wrapper -->
        <div class="vision-board-wrapper">
            <div id="visionBoard" class="vision-board horizontal">
                <div id="boardGrid" class="board-grid can-scroll">
                    <div class="empty-state">העלה תמונות כדי להתחיל ליצור את ה-Vision Board שלך</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let images = [];
        let currentZoom = 1;
        let isFitScreen = false;
        let currentOrientation = 'horizontal';
        let currentColumns = 4;
		let currentBorderColor = '#000000'; // צבע ברירת מחדל למסגרת (שחור)

        // מאזין לשינויים בקובץ
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);


		// עדכון צבע המסגרת לפי בחירה בקלט
		function updateBorderColor() {
			currentBorderColor = document.getElementById('borderColorPicker').value;
			
			// עדכן רק תמונות חדשות עם צבע המסגרת הנבחר
			const newImages = document.querySelectorAll('.image-container img.new-image');
			newImages.forEach(image => {
				image.style.border = `3px solid ${currentBorderColor}`;
				image.classList.remove('new-image'); // הסר את המחלקה כדי לא לעדכן שוב
			});
		}
		
		// עדכון צבע המסגרת לפי בחירה בקלט
		function updateBackgroundColor() {
			const currentBackgroundColor = document.getElementById('backgroundColorPicker').value;
			
			// עדכן את צבע הרקע של boardGrid
			const boardGrid = document.querySelector('#boardGrid');
			boardGrid.style.backgroundColor = currentBackgroundColor;
		}
	
		function saveCurrentPositions() {
			const containers = document.querySelectorAll('.image-container');
			containers.forEach(container => {
				const rect = container.getBoundingClientRect();
				const grid = document.querySelector('.board-grid');
				const gridRect = grid.getBoundingClientRect();
				
				// שמירת המיקום היחסי לגריד
				container.setAttribute('data-current-x', rect.left - gridRect.left);
				container.setAttribute('data-current-y', rect.top - gridRect.top);
				container.setAttribute('data-current-width', rect.width);
				container.setAttribute('data-current-height', rect.height);
			});
		}

		// פונקציה חדשה להחלת המיקומים השמורים
		function applyAbsolutePositions() {
			const containers = document.querySelectorAll('.image-container');
			containers.forEach(container => {
				const x = container.getAttribute('data-current-x');
				const y = container.getAttribute('data-current-y');
				const width = container.getAttribute('data-current-width');
				const height = container.getAttribute('data-current-height');
				
				container.style.position = 'absolute';
				container.style.left = x + 'px';
				container.style.top = y + 'px';
				container.style.width = width + 'px';
				container.style.height = height + 'px';
			});
		}

		// פונקציה חדשה לחזרה למצב עמודות
		function resetToColumns() {
			const containers = document.querySelectorAll('.image-container');
			containers.forEach(container => {
				container.style.position = '';
				container.style.left = '';
				container.style.top = '';
				container.style.transform = '';
				container.style.width = '';
				container.style.height = '';
				
				// ניקוי המידע השמור
				container.removeAttribute('data-current-x');
				container.removeAttribute('data-current-y');
				container.removeAttribute('data-current-width');
				container.removeAttribute('data-current-height');
			});
			
			
			setColumns(4);
			document.getElementById('resetToColumnsBtn').classList.add('active');
			document.getElementById('boardGrid').classList.remove('resize');
		}

        // טיפול בהעלאת תמונות
        function handleFileSelect(event) {
			const files = Array.from(event.target.files);

			files.forEach(file => {
				if (file.type.startsWith('image/')) {
					const reader = new FileReader();

					reader.onload = function(e) {
						const img = new Image();
						img.onload = function() {
							images.push({
								src: e.target.result,
								width: this.width,
								height: this.height,
								ratio: this.width / this.height,
								borderColor: currentBorderColor // שמירה של צבע המסגרת הנוכחי
							});
							updateBoard();
						};
						img.src = e.target.result;
					};

					reader.readAsDataURL(file);
				}
			});
		}

		function updateSize() {
			const widthInput = document.getElementById('widthInput');
			const heightInput = document.getElementById('heightInput');
			const board = document.getElementById('visionBoard');

			// Update the width and height of the vision board
			const width = parseInt(widthInput.value, 10);
			const height = parseInt(heightInput.value, 10);

			board.style.width = `${width}px`;
			board.style.height = `${height}px`;

			// Update the display if 'fit to screen' mode is active
			if (isFitScreen) {
				setTimeout(fitToScreen, 100);
			}

			// Adjust image display after resizing
			updateBoard();
		}

       // עדכון פונקציית setColumns
		function setColumns(num) {
			// עדכון כפתורים
			document.querySelectorAll('.column-controls button').forEach(btn => {
				btn.classList.remove('active');
			});
			document.getElementById(`col${num}`).classList.add('active');
			
			// עדכון הגריד
			const grid = document.getElementById('boardGrid');
			
			// הסרת כל ה-classes הקודמים של העמודות
			grid.classList.remove('columns-2', 'columns-3', 'columns-4');
			
			// הוספת ה-class החדש
			grid.classList.add(`columns-${num}`);
			
			// אם אתה משתמש ב-data attributes, הוסף גם אותם
			grid.setAttribute('data-columns', num);
			
			// עדכון התצוגה
			updateBoard();
		}

        // החלפת כיוון
        function setOrientation(orientation) {
			// עדכון כפתורים
			document.querySelectorAll('#horizontalBtn, #verticalBtn').forEach(btn => {
				btn.classList.remove('active');
			});
			document.getElementById(`${orientation}Btn`).classList.add('active');
			
			const board = document.getElementById('visionBoard');
			board.className = `vision-board ${orientation}`;
			
			// עדכון שדות הקלט
			const widthInput = document.getElementById('widthInput');
			const heightInput = document.getElementById('heightInput');
			
			if (orientation === 'horizontal') {
				widthInput.value = '1200';
				heightInput.value = '800';
				board.style.width = '1200px';
				board.style.height = '800px';
			} else { // vertical
				widthInput.value = '800';
				heightInput.value = '1200';
				board.style.width = '800px';
				board.style.height = '1200px';
			}
			
			// אם במצב התאמה למסך, עדכן את הסקיילינג
			if (isFitScreen) {
				setTimeout(fitToScreen, 100);
			}
			
			// עדכון תצוגת התמונות
			updateBoard();
		}

        // ערבוב תמונות
        function shuffleImages() {
            // יצירת עותק של המערך
            const shuffled = [...images];

            // Fisher-Yates shuffle algorithm
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            images = shuffled;
            updateBoard();
        }

        // עדכון הלוח
        // עדכון פונקציית updateBoard
		function updateBoard() {
			const grid = document.getElementById('boardGrid');
			grid.innerHTML = '';
			
			updateBackgroundColor();
			updateBorderColor();
			
			if (images.length === 0) {
				grid.innerHTML = '<div class="empty-state">העלה תמונות כדי להתחיל ליצור את ה-Vision Board שלך</div>';
				return;
			}
			
			images.forEach((image, index) => {
				const container = document.createElement('div');
				container.className = 'image-container';
				
				const img = document.createElement('img');
				img.src = image.src;
				img.style.border = `5px solid ${image.borderColor}`; // החלת צבע המסגרת השמור
				
				const deleteBtn = document.createElement('button');
				deleteBtn.className = 'delete-btn';
				deleteBtn.innerHTML = '×';
				deleteBtn.onclick = (e) => {
					e.stopPropagation();
					deleteImage(index);
				};
				
				container.appendChild(img);
				container.appendChild(deleteBtn);
				grid.appendChild(container);
			});
			
			if (isFitScreen) {
				setTimeout(fitToScreen, 100);
			}
			
			
		}

        // מחיקת תמונה
        function deleteImage(index) {
            images.splice(index, 1);
            updateBoard();
        }

		
        // התאמה למסך
        function fitToScreen() {
			const wrapper = document.querySelector('.vision-board-wrapper');
			const board = document.getElementById('visionBoard');
			
			const padding = 40; // רווח ביטחון
			const wrapperWidth = wrapper.clientWidth - padding;
			const wrapperHeight = wrapper.clientHeight - padding;
			
			const boardWidth = board.scrollWidth;
			const boardHeight = board.scrollHeight;
			
			// חישוב יחס הקטנה/הגדלה
			const scaleX = wrapperWidth / boardWidth;
			const scaleY = wrapperHeight / boardHeight;
			const scale = Math.min(scaleX, scaleY, 1); // לא להגדיל מעבר לגודל המקורי
			
			currentZoom = scale;
			board.style.transform = `scale(${scale})`;
			updateZoomLevel();
		}
		
		function toggleFitScreen() {
			isFitScreen = !isFitScreen;
			const btn = document.getElementById('fitScreenBtn');
			const board = document.getElementById('visionBoard');
			const grid = document.getElementById('boardGrid');
			
			if (isFitScreen) {
				btn.classList.add('active');
				board.classList.add('fit-screen');
				board.classList.add('fit-screen');
				fitToScreen();
			} else {
				btn.classList.remove('active');
                grid.classList.add('can-scroll');
                board.classList.remove('fit-screen');
                board.style.transform = 'none';
                currentZoom = 1;
				updateZoomLevel();
			}
		}


        // עדכון זום
        function adjustZoom(delta) {
            if (isFitScreen) return;

            currentZoom = Math.max(0.1, Math.min(2, currentZoom + delta));
            const board = document.getElementById('visionBoard');
            board.style.transform = `scale(${currentZoom})`;
            updateZoomLevel();
        }

        function updateZoomLevel() {
            document.getElementById('zoomLevel').textContent = `${Math.round(currentZoom * 100)}%`;
        }
		
		function downloadBoard() {
			// מציג אינדיקציה שהשמירה בתהליך
			//const saveButton = document.querySelector('.save-image-btn');
			//const originalText = saveButton.innerHTML;
			//saveButton.innerHTML = 'שומר...';
			//saveButton.disabled = true;

			// מקבל את אלמנט הלוח
			const boardGrid = document.querySelector('#boardGrid');
			
			// הגדרות מתקדמות ל-html2canvas
			const options = {
				scale: 2, // איכות גבוהה יותר
				useCORS: true, // תמיכה בתמונות מדומיינים חיצוניים
				allowTaint: true,
				backgroundColor: getComputedStyle(boardGrid).backgroundColor,
				logging: false,
				windowWidth: boardGrid.scrollWidth,
				windowHeight: boardGrid.scrollHeight,
				// שומר על הגדרות הגודל המקוריות של הלוח
				width: boardGrid.offsetWidth,
				height: boardGrid.offsetHeight,
				// מונע שבירת תוכן
				scrollX: 0,
				scrollY: 0
			};

			// יצירת התמונה
			html2canvas(boardGrid, options).then(canvas => {
				try {
					// יצירת תמונה באיכות מקסימלית
					const image = canvas.toDataURL('image/png', 1.0);
					
					// יצירת אלמנט הורדה
					const downloadLink = document.createElement('a');
					downloadLink.href = image;
					downloadLink.download = 'vision-board.png';
					
					// הורדה אוטומטית
					document.body.appendChild(downloadLink);
					downloadLink.click();
					document.body.removeChild(downloadLink);
					
					// החזרת הכפתור למצב הרגיל
					//saveButton.innerHTML = originalText;
					//saveButton.disabled = false;
				} catch (error) {
					console.error('שגיאה בשמירת הלוח:', error);
					alert('אירעה שגיאה בשמירת הלוח. אנא נסה שנית.');
					saveButton.innerHTML = originalText;
					saveButton.disabled = false;
				}
			}).catch(error => {
				console.error('שגיאה ביצירת התמונה:', error);
				alert('אירעה שגיאה ביצירת התמונה. אנא נסה שנית.');
				saveButton.innerHTML = originalText;
				saveButton.disabled = false;
			});
		}
			
        // אתחול
        document.addEventListener('DOMContentLoaded', () => {
            setColumns(4);
            setOrientation('horizontal');
			initializeInteractions();
        });
		
		// הוספת האזנה לשינויי גודל חלון
		window.addEventListener('resize', () => {
			if (isFitScreen) {
				fitToScreen();
			}
		});

		let highestZIndex = 1000; // משתנה גלובלי לזיהוי ה-z-index הגבוה ביותר

		function initializeInteractions() {
			interact('.image-container')
				.draggable({
					inertia: true,
					modifiers: [
						interact.modifiers.restrict({
							restriction: '.board-grid',
							elementRect: {
								top: 0,
								left: 0,
								bottom: 1,
								right: 1
							}
						})
					],
					listeners: {
						start(event) {
								const grid = document.querySelector('.board-grid');
								document.querySelectorAll('.column-controls button').forEach(btn => {
									btn.classList.remove('active');
								});
								document.getElementById('resetToColumnsBtn').classList.remove('active');

								if (!grid.classList.contains('resizing')) {
									saveCurrentPositions();
									grid.classList.add('resizing');
									//applyAbsolutePositions();
								}
								
							const target = event.target;
							
							// עדכון ה-z-index לגבוה ביותר בעת כל התחלת גרירה
							highestZIndex++;
							target.setAttribute('data-z-index', highestZIndex);
							target.style.zIndex = highestZIndex;
						},
						move(event) {
							const target = event.target;
							const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
							const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

							target.style.transform = `translate(${x}px, ${y}px)`;
							target.setAttribute('data-x', x);
							target.setAttribute('data-y', y);
						}
					}
				})
				.resizable({
					edges: { left: true, bottom: true },
					listeners: {
						start(event) {
							const target = event.target;
							
							const grid = document.querySelector('.board-grid');
								document.querySelectorAll('.column-controls button').forEach(btn => {
									btn.classList.remove('active');
								});
								document.getElementById('resetToColumnsBtn').classList.remove('active');

								if (!grid.classList.contains('resizing')) {
									saveCurrentPositions();
									grid.classList.add('resizing');
									//applyAbsolutePositions();
								}
								

							// שמור על יחס הרוחב/גובה המקורי
							const aspectRatio = target.offsetWidth / target.offsetHeight;
							target.setAttribute('data-aspect-ratio', aspectRatio);

							// אם אין z-index שמור, עדכן אותו
							if (!target.getAttribute('data-z-index')) {
								highestZIndex++;
								target.setAttribute('data-z-index', highestZIndex);
							}

							// תמיד להשתמש ב-z-index הגבוה ביותר מהתכונה
							target.style.zIndex = target.getAttribute('data-z-index');
						},
						move(event) {
							const target = event.target;

							// קבל את יחס הרוחב/גובה המקורי
							const aspectRatio = parseFloat(target.getAttribute('data-aspect-ratio'));

							// שמור על יחס הרוחב/גובה
							const newWidth = event.rect.width;
							const newHeight = newWidth / aspectRatio;  // מחשבים את הגובה בהתאם ליחס

							// שמור על מיקום ה-X המקורי
							const x = parseFloat(target.getAttribute('data-x')) || 0;
							const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.deltaRect.top;

							Object.assign(target.style, {
								width: `${newWidth}px`,
								height: `${newHeight}px`,
								transform: `translate(${x}px, ${y}px)`
							});

							target.setAttribute('data-x', x);
							target.setAttribute('data-y', y);
						}
					}
				});
		}
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
</body>
</html>
